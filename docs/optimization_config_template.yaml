# ==============================================================================
# EMTO Input Automation - Complete Configuration Template
# ==============================================================================
# This template includes ALL available configuration options with detailed
# explanations. Copy this file and modify values as needed for your calculation.
#
# REQUIRED fields are marked with (REQUIRED)
# OPTIONAL fields show default values
# ==============================================================================

# ------------------------------------------------------------------------------
# BASIC SETTINGS
# ------------------------------------------------------------------------------

output_path: "output_directory"     # (REQUIRED) Base directory for all results
job_name: "job_identifier"          # (REQUIRED) Job name used in filenames


# ------------------------------------------------------------------------------
# STRUCTURE INPUT - Choose ONE of two approaches
# ------------------------------------------------------------------------------

# Option 1: CIF File Input (for ordered structures)
cif_file: "path/to/structure.cif"   # Path to CIF file (set to null if using lattice params)

# Option 2: Lattice Parameter Input (for alloys and custom structures)
lat: null                            # EMTO lattice type (1-14, see LATTICE_TYPES.md)
a: null                              # Lattice parameter a (Angstroms)
b: null                              # Lattice parameter b (default: same as a)
c: null                              # Lattice parameter c (default: same as a for cubic, 1.633*a for HCP)
alpha: null                          # Lattice angle alpha (degrees, REQUIRED for LAT 14 triclinic)
beta: null                           # Lattice angle beta (degrees, REQUIRED for LAT 14 triclinic)
gamma: null                          # Lattice angle gamma (degrees, REQUIRED for LAT 12-14 monoclinic/triclinic)

# Site specifications for parameter-based input (REQUIRED if not using CIF)
# Example - FCC Cu-Mg random alloy:
#   sites: [{'position': [0, 0, 0], 'elements': ['Cu', 'Mg'], 'concentrations': [0.8, 0.2]}]
# Example - L10 ordered structure:
#   sites: [{'position': [0, 0, 0], 'elements': ['Fe'], 'concentrations': [1.0]},
#           {'position': [0.5, 0.5, 0.5], 'elements': ['Pt'], 'concentrations': [1.0]}]
sites: null

# Element substitutions for CIF files (optional)
# Use this to create alloy structures from pure element CIF files
# Replaces ALL sites of each specified element with the given composition
# Set to null for regular CIF workflow (no substitutions)
substitutions: null
# Example - Replace Fe with Fe0.7Co0.3 alloy, keep Pt pure:
#   substitutions:
#     Fe:
#       elements: ['Fe', 'Co']
#       concentrations: [0.7, 0.3]
#     Pt:
#       elements: ['Pt']
#       concentrations: [1.0]
# Notes:
#   - Only works with CIF files (cif_file must be provided)
#   - For parameter-based alloys, use 'sites' specification instead
#   - All concentrations must sum to 1.0
#   - All elements in substitutions must exist in the CIF structure

# ------------------------------------------------------------------------------
# PARAMETER RANGES - Controls c/a and SWS sweeps
# ------------------------------------------------------------------------------

# Direct specification (use ONE of these for each parameter)
ca_ratios: null                      # List of c/a ratios: [0.96, 0.98, 1.00, 1.02, 1.04]
                                     # If null: uses structure's c/a ratio
                                     # If single value: auto-generates range around it (if auto_generate=true)
sws_values: null                     # List of SWS values: [2.60, 2.65, 2.70]
                                     # If null: calculates from structure volume
                                     # If single value: auto-generates range around it (if auto_generate=true)

# Auto-generation from single values (creates range around provided value)
auto_generate: false                 # Auto-generate ranges if single value provided (default: false)
                                     # When true: single values automatically generate ranges (±3×step, n_points)
                                     # When false: use provided lists as-is or calculate from structure
ca_step: 0.02                        # Step size for c/a range (default: 0.02)
sws_step: 0.05                       # Step size for SWS range (default: 0.05)
n_points: 7                          # Number of points in auto-generated range (default: 7)

# Initial SWS for c/a optimization (Phase 1)
initial_sws: null                    # SWS value(s) to use during c/a optimization
                                     # If null: uses middle value from sws_values

# Missing value handling:
# - User-provided lists (explicit lists with >1 element): Strict validation by default
#   → Missing values cause errors (workflow stops)
# - Auto-generated values (single value, null, or auto-calculated): Lenient validation
#   → Missing values are skipped with warnings (workflow continues)
# - lenient_validation: Override to use lenient mode even for user-provided lists
#   → Set to true to skip missing values even when you explicitly provide a list
# - Minimum requirement: At least 3 successful calculations required for EOS fitting
#   → Even in lenient mode, workflow fails if <3 successful calculations
# - Job scripts automatically skip failed values and continue to next parameter

lenient_validation: false              # Use lenient validation for all values (default: false)
                                       # When true: Missing values are skipped even for user-provided lists
                                       # When false: Strict validation for user-provided lists, lenient for auto-generated


# ------------------------------------------------------------------------------
# EMTO CALCULATION PARAMETERS
# ------------------------------------------------------------------------------

dmax: null                           # Maximum distance parameter for neighbor shells
                                     # Typical values: 1.3-2.5 (default: 1.8 if null)

magnetic: "P"                        # Magnetic configuration:
                                     # "P" = Paramagnetic (default)
                                     # "F" = Ferromagnetic
                                     # Note: "A" (Antiferromagnetic) is not currently supported

user_magnetic_moments: null          # Custom magnetic moments per element
                                     # Example: {'Fe': 2.2, 'Co': 1.7, 'Ni': 0.6}
                                     # If null: uses default database values

functional: "GGA"                    # Exchange-correlation functional/pseudopotential:
                                     # "GGA" = Generalized Gradient Approximation (default)
                                     # "LDA" = Local Density Approximation
                                     # "LAG" = Langreth-Lundqvist


# ------------------------------------------------------------------------------
# K-MESH SETTINGS
# ------------------------------------------------------------------------------

# Automatic Monkhorst-Pack mesh (default)
nkx: 21                              # K-mesh divisions along x-axis (default: 21)
nky: 21                              # K-mesh divisions along y-axis (default: 21)
nkz: 21                              # K-mesh divisions along z-axis (default: 21)

# K-point rescaling based on lattice parameters (optional)
rescale_k: false                     # Enable k-point rescaling (default: false)
                                     # When enabled, automatically rescales k-points to maintain
                                     # constant reciprocal-space density across different structures
                                     # Uses hard-coded reference: (3.86 Å, 3.86 Å, 3.76 Å) with k-mesh (21, 21, 21)
                                     # Formula: N'_i = (a_ref × N_ref) / a'_i, rounded to nearest integer
                                     # Applied once at initial file creation (same k-mesh for all phases)

# KGRN calculation parameters
depth: 1.100                         # DEPTH parameter for KGRN (default: 1.100)
                                     # Controls the depth of the calculation
                                     # Format: 7 characters maximum (e.g., "  1.100")

efmix: 0.900                         # EFMIX parameter for KGRN (default: 0.900)
                                     # Fermi energy mixing parameter

tolcpa: 1.0e-06                      # TOLCPA parameter for KGRN (default: 1.d-06)
                                     # Tolerance for CPA convergence
                                     # Format: Fortran scientific notation (e.g., 1.d-06)

tolef: 1.0e-08                       # TOLEF parameter for KGRN (default: 1.d-08)
                                     # Tolerance for Fermi energy convergence
                                     # Format: Fortran scientific notation (e.g., 1.d-08)

efgs: 0.000                          # EFGS parameter for KGRN (default: 0.000)
                                     # Fermi energy for Green's function

hx: 0.101                            # HX parameter for KGRN (default: 0.101)
                                     # Step size for energy integration

nx: 5                                # NX parameter for KGRN (default: 5)
                                     # Number of energy points

amix: 0.010                          # AMIX parameter for KGRN (default: 0.010)
                                     # Mixing parameter for charge density

vmix: 0.70                           # VMIX parameter for KGRN (default: 0.70)
                                     # Mixing parameter for potential

imagz: 0.005                         # IMAGZ parameter for KGRN (default: 0.005)
                                     # Imaginary part of energy for complex contour integration

eps: 0.200                           # EPS parameter for KGRN (default: 0.200)
                                     # Energy parameter for integration

nz0: 16                              # NZ0 parameter for KGRN (default: 16)
                                     # Number of z-points for integration

# ------------------------------------------------------------------------------
# OPTIMIZATION FLAGS - Enable/disable optimization phases
# ------------------------------------------------------------------------------

optimize_ca: false                   # Enable c/a ratio optimization (Phase 1)
optimize_sws: false                  # Enable SWS (volume) optimization (Phase 2)

# Note on missing values during optimization:
# - If calculations fail for specific c/a or SWS values, the workflow behavior depends
#   on whether values were user-provided or auto-generated:
#   * User-provided lists: Workflow stops with error  validation)
#   * Auto-generated values: Missing values are skipped, workflow continues (lenient)
# - Job scripts automatically skip failed values and continue processing remaining values
# - At least 3 successful calculations are required for EOS fitting (applies to both modes)


# ------------------------------------------------------------------------------
# DMAX OPTIMIZATION - Automatic cutoff distance optimization
# ------------------------------------------------------------------------------
# DMAX optimization finds optimal cutoff distances for each c/a ratio to maintain
# consistent neighbor shell counts. This ensures comparable k-point density.
#
# REQUIREMENTS:
#   - Requires at least 2 c/a ratios (or set auto_generate=true)
#   - Requires kstr_executable path
#   - Processes ratios sequentially (not in parallel)
#   - Uses early termination for ~300-600x speedup

optimize_dmax: false                 # Enable automatic DMAX optimization (default: false)
dmax_initial: 2.0                    # Initial DMAX guess (default: 2.0)
                                     # Should be large enough for the LARGEST c/a ratio
                                     # Tip: Start with 2.5-3.0 for complex structures
dmax_target_vectors: 100             # Target number of k-vectors (default: 100)
dmax_vector_tolerance: 15            # Acceptable deviation ±N vectors (default: 15)
kstr_executable: null                # Path to KSTR executable (REQUIRED if optimize_dmax=true)
                                     # Example: "/path/to/kstr.exe"


# ------------------------------------------------------------------------------
# EXECUTION SETTINGS
# ------------------------------------------------------------------------------

run_mode: "local"                    # Execution mode:
                                     # "local" = Run on local machine (default)
                                     # "sbatch" = Submit to SLURM queue

prcs: 8                              # Number of processors per job (default: 8)

# SLURM settings (only used if run_mode="sbatch")
slurm_account: "naiss2025-1-38"      # SLURM account (default: "naiss2025-1-38")
slurm_partition: "main"              # SLURM partition (default: "main")
slurm_time: "02:00:00"               # Time limit HH:MM:SS (default: "02:00:00")

# Job script settings
create_job_script: true              # Generate job submission scripts (default: true)
job_mode: "serial"                   # Job execution mode:
                                     # "serial" = Sequential execution (default)
                                     # "parallel" = Parallel execution with dependencies

# Master job script for batch submission (only used with generate_percentages)
create_master_job_script: false      # Generate master script to submit multiple YAML files (default: false)
                                     # When enabled in generate_percentages, automatically creates:
                                     #   - Individual job scripts (job_<composition>.sh) for each generated YAML file
                                     #   - A master script (master_job_script.sh) that submits all jobs
                                     # Uses slurm_account, prcs, and slurm_time from this config
                                     # Note: Only works when running generate_percentages.py
                                     # All scripts are created in the same directory as the generated YAML files


# ------------------------------------------------------------------------------
# EXECUTABLE PATHS - Paths to EMTO binaries
# ------------------------------------------------------------------------------
# Update these paths to point to your EMTO installation
# Required if optimize_dmax=true or create_job_script=true

kstr_executable: "/path/to/kstr.exe"           # KSTR executable (required for DMAX optimization)
shape_executable: "/path/to/shape.exe"         # SHAPE executable (required for job scripts)
kgrn_executable: "/path/to/kgrn_mpi.x"         # KGRN executable (required for job scripts)
kfcd_executable: "/path/to/kfcd.exe"           # KFCD executable (required for job scripts)
eos_executable: "/path/to/eos.exe"             # EOS executable (required for optimization workflows)


# ------------------------------------------------------------------------------
# EQUATION OF STATE SETTINGS
# ------------------------------------------------------------------------------

eos_type: "MO88"                     # EOS fitting type:
                                     # "MO88" = Morse (default)
                                     # "POLN" = Polynomial
                                     # "SPLN" = Spline
                                     # "MU37" = Murnaghan
                                     # "ALL" = Fit all types

# Symmetric EOS fitting - Automatically selects symmetric points around equilibrium
symmetric_fit: true                  # Enable symmetric point selection (default: true)
                                     # When enabled and many points (>n_points_final) are provided:
                                     # 1. Performs initial fit with all points to find equilibrium
                                     # 2. Selects n_points_final symmetric points around equilibrium
                                     # 3. Performs final fit with selected points (used for optimization)
                                     # This ensures symmetric energy curves for better fit quality
                                     # Warnings are issued (but workflow continues) if:
                                     # - Equilibrium is outside input range
                                     # - Symmetric selection is not possible
                                     # - Fewer than requested points available

n_points_final: 7                    # Number of points for final symmetric fit (default: 7)
                                     # Only used when symmetric_fit=true and more points are provided
                                     # Typical values: 5-9 (7 is recommended)

# Automatic range expansion for out-of-range equilibrium
eos_auto_expand_range: false         # Enable automatic range expansion (default: false)
                                     # When enabled: If equilibrium falls outside input range or
                                     # EOS fit returns NaN values, automatically:
                                     # 1. Estimates minimum using Modified Morse EOS fitting
                                     #    - Uses robust convergence (maxfev=20000, method='trf')
                                     #    - Safety check: If energy decreasing and estimate < max(param),
                                     #      uses max(param) instead (estimation was wrong)
                                     #    - If fit fails: Uses max(param) if energy decreasing, else min(param)
                                     # 2. Generates new parameter vector centered around estimate
                                     #    (uses same number of points as initial user input)
                                     # 3. Runs calculations for new points (if needed)
                                     # 4. Always saves expanded workflow points to file
                                     # 5. Chooses data source for EOS fit based on eos_use_saved_data flag:
                                     #    - true: Uses ALL points from saved file (may include previous runs)
                                     #    - false: Uses ONLY workflow points (initial + newly calculated)
                                     # 6. Re-fits EOS with selected data
                                     #    (symmetric selection only applied if symmetric_fit=true)
                                     # 7. If still not converged, estimates equilibrium from all data
                                     #    and suggests initial_sws/ca_ratios value, then raises error
                                     # Note: Only performs ONE expansion (not iterative)
                                     # Note: Range width is automatically calculated from number of points
                                     #   and step_size: range_width = (n_points - 1) × step_size

# Data persistence and re-use for EOS fitting
# IMPORTANT: Data is ALWAYS saved to file automatically (no option to disable)
# This flag controls which data to use for EOS fitting:
eos_use_saved_data: false            # Choose data source for EOS fitting (default: false)
                                     # When true: Use ALL points from saved file (accumulated over multiple runs)
                                     #   - Includes data from all previous workflow runs
                                     #   - Applies to initial EOS fit and after expansion
                                     # When false: Use ONLY current workflow's array (just generated in this run)
                                     #   - Initial fit uses only current workflow points
                                     #   - After expansion, uses only workflow points (initial + newly calculated)
                                     # Saving to file happens automatically regardless of this flag
                                     # Saved files: {phase_path}/sws_energy_data.json or {phase_path}/ca_energy_data.json

# Final fit data source after expansion
eos_use_all_saved_for_final_fit: false  # Use all saved data for final fit after expansion (default: false)
                                         # When true: After expansion, use ALL points from saved file for final EOS fit
                                         #   - Includes original workflow points + expanded points + any previous runs
                                         # When false: After expansion, use ONLY the expanded parameter vector for final fit
                                         #   - Uses only the newly generated points around the estimated minimum
                                         #   - This is the default and recommended for focused fitting
                                         # Note: This only affects the final fit after expansion, not the initial fit


# ------------------------------------------------------------------------------
# ANALYSIS SETTINGS
# ------------------------------------------------------------------------------

generate_plots: true                 # Generate EOS and DOS plots (default: true)
export_csv: true                     # Export results to CSV format (default: true)
plot_format: "png"                   # Plot file format: png, pdf, svg (default: "png")

generate_dos: false                  # Generate DOS files during calculations (default: false)
dos_plot_range: [-0.8, 0.15]         # Energy range (x-axis) for DOS plots in Ry (default: [-0.8, 0.15])
dos_ylim: null                       # DOS range (y-axis) for DOS plots in states/Ry (default: null = auto-scale)
                                     # Example: [0, 10] to set y-axis from 0 to 10 states/Ry


# ------------------------------------------------------------------------------
# REFERENCE VALUES - For percentage calculations in results
# ------------------------------------------------------------------------------

reference_ca: null                   # Reference c/a ratio for % deviation calculations
reference_sws: null                  # Reference SWS value for % deviation calculations
reference_volume: null               # Reference volume for % deviation calculations


# ------------------------------------------------------------------------------
# JOB MONITORING SETTINGS
# ------------------------------------------------------------------------------

poll_interval: 30                    # Check job status every N seconds (default: 30)
max_wait_time: 7200                  # Maximum wait time in seconds (default: 7200 = 2 hours)
timeout_action: "stop"               # Action on timeout (default: "stop")
                                     # Currently always stops workflow on timeout
                                     # Other options reserved for future implementation


# ------------------------------------------------------------------------------
# ADVANCED SETTINGS
# ------------------------------------------------------------------------------
# Note: Some of these parameters are reserved for future features

skip_existing: false                 # Skip calculations if output files exist (default: false)
                                     # Reserved for future implementation
save_intermediate: true              # Save intermediate results to JSON (default: true)
cleanup_temp: false                  # Remove temporary files after completion (default: false)
                                     # Reserved for future implementation
log_level: "INFO"                    # Logging verbosity (default: "INFO")
                                     # Reserved for future logging configuration
                                     # Valid values: "DEBUG", "INFO", "WARNING", "ERROR"


# ------------------------------------------------------------------------------
# WORKFLOW MODE
# ------------------------------------------------------------------------------

prepare_only: false                  # Prepare input files only, don't run calculations (default: false)
                                     # Useful for generating inputs to run manually or on a different system


# ------------------------------------------------------------------------------
# ALLOY PERCENTAGE LOOP - Systematic composition variation
# ------------------------------------------------------------------------------
# NOTE: The recommended workflow is to use generate_percentages.py to create
# separate YAML files for each composition, then run them individually.
# This loop_perc feature is still available but generates files automatically.
# See ALLOY_COMPOSITION_LOOPS.md for detailed documentation

loop_perc: null                      # Set to a dictionary to enable alloy composition loop
                                     # If null: single composition calculation (default)
                                     # Recommended: Use bin/generate_percentages.py instead

# Example configuration for alloy percentage loop:
# loop_perc:
#   enabled: true                    # Enable composition loop (REQUIRED if using loop_perc)
#   start: 0                         # Starting percentage (default: 0)
#   end: 100                         # Ending percentage (default: 100)
#   step: 10                         # Percentage step size (default: 10)
#   site_index: 0                    # Site index to vary (0-based, default: 0)
#                                    # Can be integer (single site) or list [0, 1] (multiple sites)
#                                    # When list: same percentages applied to all sites
#                                    # All sites must have same number of elements
#                                    # Concentrations always match element order in site
#   substitution_elements: null     # For CIF method: specify elements directly (recommended)
#                                    # Example: ['Cu', 'Mg'] - updates substitutions for these elements
#                                    # More intuitive than site_index for substitutions
#                                    # All specified substitutions must have same elements
#   phase_diagram: false             # Generate phase diagram data (default: false)
#   percentages: null                # Custom list of percentages (overrides start/end/step)
#                                    # Format: [[p1_elem1, p1_elem2], [p2_elem1, p2_elem2], ...]
#                                    # Example: [[0,100], [25,75], [50,50], [75,25], [100,0]]

# Example 1: Loop Cu concentration from 0-100% in Cu-Mg FCC alloy (single site)
# loop_perc:
#   enabled: true
#   start: 0
#   end: 100
#   step: 10
#   site_index: 0        # First site at position [0, 0, 0]
#                        # Single element sweep always varies first element (Cu)
#                        # Concentrations match element order: [Cu%, Mg%]

# Example 2: Vary multiple sites simultaneously with same percentages
# For parameter method (lat, a, sites):
#   sites:
#     - position: [0, 0, 0]
#       elements: ['Cu', 'Mg']
#       concentrations: [1.0, 0.0]
#     - position: [0.333, 0.666, 0.5]
#       elements: ['Cu', 'Mg']
#       concentrations: [0.0, 1.0]
# loop_perc:
#   enabled: true
#   step: 10
#   site_index: [0, 1]  # List of sites - apply same percentages to both sites
#   phase_diagram: true    # Generate all combinations
# Note: Both sites must have same elements ['Cu', 'Mg'] and same number of elements

# Example 3: Vary multiple substitutions simultaneously (CIF method)
# For CIF file with Cu and Mg sites:
#   substitutions:
#     Cu:
#       elements: ['Cu', 'Mg']
#       concentrations: [0.1, 0.9]
#     Mg:
#       elements: ['Cu', 'Mg']
#       concentrations: [0.0, 1.0]
# loop_perc:
#   enabled: true
#   step: 10
#   substitution_elements: ['Cu', 'Mg']  # Specify elements directly (recommended)
#   # OR use site_index: [0, 1]  # Legacy: sites corresponding to Cu and Mg base elements
#   phase_diagram: true
# Note: Both substitutions must have same elements ['Cu', 'Mg']
#       The same percentages will be applied to BOTH Cu and Mg substitutions
#       Substitutions replace ALL sites of each element, so specifying elements is clearer

# ==============================================================================
# END OF CONFIGURATION TEMPLATE
# ==============================================================================
