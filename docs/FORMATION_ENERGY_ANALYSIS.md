# Formation Energy Analysis

This document describes the scripts for extracting and analyzing formation energies from EMTO alloy calculations.

## Overview

The formation energy analysis tools extract phase 3 total energies from EMTO calculations and compute formation energies using:

```
E_form(Cu_x, Mg_{1-x}) = E(Cu_x, Mg_{1-x}) - x*E(Cu) - (1-x)*E(Mg)
```

where:
- `E(Cu_x, Mg_{1-x})` is the total energy of the alloy
- `E(Cu)` is the total energy of pure Cu
- `E(Mg)` is the total energy of pure Mg
- `x` is the concentration of Cu (between 0 and 1)

## Scripts

### 1. Python Script (Recommended)

**File:** `bin/extract_formation_energy.py`

This script extracts phase 3 energies, calculates formation energies, and generates plots automatically.

**Usage:**
```bash
cd /path/to/CuMg_fcc  # Navigate to the folder with Cu*_Mg* subdirectories
python extract_formation_energy.py
```

**Output:**
- `energies_raw.dat` - Raw total energies for each composition
- `formation_energies.dat` - Formation energies for each composition
- `formation_energy_vs_composition.png` - Plot of formation energy vs Cu percentage

**Requirements:**
- Python 3.6+
- numpy
- matplotlib

### 2. Bash Script

**File:** `bin/extract_formation_energy.sh`

A bash-only alternative that extracts energies and calculates formation energies without Python dependencies.

**Usage:**
```bash
cd /path/to/CuMg_fcc
bash extract_formation_energy.sh
```

**Output:**
- `energies_raw.dat` - Raw total energies
- `formation_energies.dat` - Formation energies

To plot after running the bash script:
```bash
python plot_formation_energy.py
```

### 3. Plotting Script

**File:** `bin/plot_formation_energy.py`

Standalone plotting script for data generated by either extraction method.

**Usage:**
```bash
# Plot formation energies
python plot_formation_energy.py

# Plot raw total energies
python plot_formation_energy.py --raw
```

## Directory Structure

The scripts expect a directory structure like:

```
CuMg_fcc/
├── Cu0_Mg100/
│   ├── workflow_results.json
│   └── ...
├── Cu10_Mg90/
│   ├── workflow_results.json
│   └── ...
├── Cu20_Mg80/
├── ...
├── Cu100_Mg0/
└── ...
```

## Energy Extraction

The scripts read the final energy from `workflow_results.json` files in each composition folder.

Expected JSON structure:
```json
{
  "job_name": "CuMg",
  "optimal_ca": 1.0,
  "optimal_sws": 2.7033254965,
  "phases_completed": ["phase2_sws_optimization", "phase3_optimized_calculation", "dos_analysis"],
  "final_energy": -3310.060502,
  "structure_info": {
    "lattice_type": 2,
    "lattice_name": "Face-centered cubic",
    "num_atoms": 1
  }
}
```

The scripts look for the `final_energy` field, which contains the optimized total energy in Rydberg units.

## Output Format

### energies_raw.dat
```
# Cu_percent  Energy(Ry)
    0  -123.45678901
   10  -123.45678902
   20  -123.45678903
  ...
```

### formation_energies.dat
```
# Cu_percent  FormationEnergy(Ry)
    0   0.00000000
   10  -0.00012345
   20  -0.00023456
  ...
```

## Troubleshooting

### "No energies were extracted"
- Check that `workflow_results.json` files exist in each composition folder
- Verify that the JSON files contain phase 3 energy data
- Run the Python script to see which keys are available in the JSON files

### "Missing pure element energies"
- Ensure both `Cu0_Mg100` and `Cu100_Mg0` folders exist
- Verify that these folders contain valid `workflow_results.json` files with phase 3 energies

### "Energy not found in workflow_results.json"
The Python script will print available keys if it can't find the energy. Check the JSON structure and modify the `extract_phase3_energy()` function if needed to match your specific JSON format.

### Bash Script Notes
- The bash script works best with `jq` installed for JSON parsing
- Without `jq`, it falls back to basic grep patterns which may be less robust
- Install jq: `sudo apt install jq` (Linux) or `brew install jq` (macOS)

## Example Workflow

```bash
# 1. Navigate to your alloy calculation directory
cd /path/to/CuMg_fcc

# 2. Run the extraction and plotting (Python)
python /path/to/EMTO_input_automation/bin/extract_formation_energy.py

# OR use bash script + separate plotting
bash /path/to/EMTO_input_automation/bin/extract_formation_energy.sh
python /path/to/EMTO_input_automation/bin/plot_formation_energy.py

# 3. View results
cat formation_energies.dat
open formation_energy_vs_composition.png  # macOS
# Or xdg-open formation_energy_vs_composition.png  # Linux
```

## Notes

- Formation energy values are typically negative for stable alloys
- Pure elements (0% and 100%) should have formation energy = 0 by definition
- The scripts require that both pure Cu and pure Mg calculations exist
